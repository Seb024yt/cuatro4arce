<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f4f6f9; color: #333; }
        .navbar {
            background: #2d3748;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fee2e2; color: #991b1b; }
        .btn-action { background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .logout-btn { color: white; text-decoration: none; opacity: 0.8; }
        .logout-btn:hover { opacity: 1; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 700px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: black; }
        .company-list { margin-top: 15px; }
        .company-item { border: 1px solid #eee; padding: 10px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .edit-form { display: none; margin-top: 10px; background: #f9f9f9; padding: 10px; border-radius: 4px; }
        .edit-form input { width: 100%; margin-bottom: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>Administración</h1>
        <a href="#" class="logout-btn" onclick="logout()">Cerrar Sesión</a>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2>Usuarios Registrados</h2>
            <input type="text" id="searchInput" placeholder="Buscar por email..." 
                   style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 300px;">
        </div>
        <div class="card">
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Estado Pago</th>
                        <th>Folio</th>
                        <th>Empresas</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="companiesModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Gestión de Empresas</h3>
            <div id="companiesList" class="company-list">
                <!-- Companies loaded here -->
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        let allUsers = [];

        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.status === 403) {
                    alert("Acceso denegado. No es administrador.");
                    window.location.href = '/dashboard';
                    return;
                }

                allUsers = await res.json();
                renderUsers(allUsers);
            } catch (err) {
                console.error(err);
                alert("Error al cargar usuarios");
            }
        }

        function renderUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const companies = user.companies.map(c => c.name).join(', ') || 'Sin empresas';
                const statusClass = user.payment_status === 'paid' ? 'status-paid' : 'status-pending';
                const statusText = user.payment_status === 'paid' ? 'PAGADO' : 'PENDIENTE';
                const folio = user.payment_folio || '-';
                
                let actionBtn = '';
                if (user.payment_status !== 'paid') {
                    actionBtn = `<button class="btn-action" onclick="activateUser(${user.id})">Activar</button>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.email} ${user.is_admin ? '<span style="color:gold">★</span>' : ''}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><small>${folio}</small></td>
                    <td>
                        ${companies} 
                        <button class="btn-action" style="background:#667eea; font-size:0.8rem; margin-left:5px;" onclick="viewCompanies(${user.id})">Editar</button>
                    </td>
                    <td>${actionBtn}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => u.email.toLowerCase().includes(term));
            renderUsers(filtered);
        });

        async function activateUser(userId) {
            if (!confirm('¿Activar manualmente a este usuario?')) return;
            try {
                const res = await fetch(`/api/admin/users/${userId}/activate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    loadUsers();
                } else {
                    alert("Error al activar");
                }
            } catch (err) {
                console.error(err);
            }
        }

        function viewCompanies(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const list = document.getElementById('companiesList');
            list.innerHTML = '';
            
            if (user.companies.length === 0) {
                list.innerHTML = '<p>No tiene empresas registradas.</p>';
            } else {
                user.companies.forEach(comp => {
                    const item = document.createElement('div');
                    item.className = 'company-item-container';
                    item.innerHTML = `
                        <div class="company-item">
                            <div>
                                <strong>${comp.name}</strong><br>
                                <small>${comp.rut}</small>
                            </div>
                            <button class="btn-action" onclick="toggleEdit(${comp.id})">Editar</button>
                        </div>
                        <div id="edit-${comp.id}" class="edit-form">
                            <input type="text" id="name-${comp.id}" value="${comp.name}" placeholder="Nombre">
                            <input type="text" id="rut-${comp.id}" value="${comp.rut}" placeholder="RUT">
                            <input type="password" id="pass-${comp.id}" placeholder="Nueva Clave SII (dejar vacío si no cambia)">
                            <button class="btn-action" onclick="saveCompany(${comp.id})">Guardar Cambios</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            
            document.getElementById('companiesModal').style.display = 'block';
        }

        function toggleEdit(compId) {
            const form = document.getElementById(`edit-${compId}`);
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }

        async function saveCompany(compId) {
            const name = document.getElementById(`name-${compId}`).value;
            const rut = document.getElementById(`rut-${compId}`).value;
            const pass = document.getElementById(`pass-${compId}`).value;
            
            const data = { name, rut };
            if (pass) data.clave_sii = pass;

            try {
                const res = await fetch(`/api/admin/companies/${compId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert("Empresa actualizada");
                    loadUsers(); // Reload to refresh local data
                    closeModal();
                } else {
                    const err = await res.json();
                    alert(err.detail || "Error al actualizar");
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexión");
            }
        }

        function closeModal() {
            document.getElementById('companiesModal').style.display = 'none';
        }
        
        // Close modal if clicked outside
        window.onclick = function(event) {
            const modal = document.getElementById('companiesModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function logout() {
            localStorage.removeItem('token');
            document.cookie = 'access_token=; Max-Age=0; path=/;';
            window.location.href = '/login';
        }

        loadUsers();
    </script>
</body>
</html>